<!DOCTYPE html>
<html>

  <head>

	<!-- 
		Theme: Glas
		Theme: by Lucas Gatsas
		Web: spaceg.github.io
		Fr. 26. Feb. 2016 06:15:13
    Update 
    So. 9.July . 2017 08:55:44

	-->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Implement Passportjs authentication with Sailsjs</title>
  <meta name="description" content="sailsjs, passportjs, nodejss">
  <link rel="canonical" href="http://localhost:8000/event/Implement-Passport.js-authentication-with-Sails.js.html">
  <link rel="alternate" type="application/rss+xml" title="Lucas Gatsas" href="http://localhost:8000/feed.xml">
  <link rel="stylesheet" href="/assets/css/style-v=cba79c2df0.css">
  <link rel="stylesheet" type="text/css" href="assets/css/style-v=cba79c2df0.css" />
      <link rel="shortcut icon" href="yoursite.ch/icon.png">
    <link rel="icon" href="yoursite.ch/icon.png" type="image/x-icon">
</head>


<body class="home-template">
  <div id="page" class="site">


    


<header class="site-header">
    <div class="inner-wide">
        <h1 class="site-title"><a href="/" id="glas-logo-1">    <img src="/img/avatar@2x.png" style="height:40px;" alt="Lucas Gatsas"></a><!--Lucas Gatsas--></a></h1>
        <nav class="site-navigation" role="navigation">
    <h2 class="screen-reader-text">hello</h2>
    <ul class="menu">
        <li class="menu-item home current-menu-item" role="presentation"><a href="/">Home</a></li>
         
          
            
                <a class="page-link" href="/about/">About</a>
            
          
        
          
        
          
            
                <a class="page-link" href="/archive/">Archive</a>
            
          
        
          
        
          
        
          
        
    </ul><!-- .menu -->
</nav><!-- .site-navigation -->

        <a class="sidebar-toggle"><span class="screen-reader-text">Open Sidebar</span><span class="icon" aria-hidden="true"></span></a>
    </div><!-- .inner-wide -->
</header><!-- .site-header -->
        

<div class="sidebar">
    <div class="sidebar-scrollable">
        <div class="widget-area">
                <nav class="site-navigation" role="navigation">
    <ul class="menu">
 
    </ul><!-- .menu -->
</nav><!-- .site-navigation -->

            <aside class="widget widget-text">
                    <p>    
                            <img src="http://127.0.0.1:8000/assets/img/avatar@2x.png" style="    text-align: center;margin: 0 auto;display: -webkit-box;height: 80px;width: 80px;" alt="Jane Doe" class="author-avatar" />
                        </p>
                <h2 class="widget-title" style="    text-align: center;"">This is my Developer Blog New.</h2>
                <p style="    text-align: center;"">you can modify this sidebar in the organisers.yml file.</p>
            </aside><!-- .widget -->
            <aside class="widget widget-newsletter">
                <h2 class="widget-title">My  Newsletter</h2>
                <p>you can modify this sidebar in the organisers.yml file.</p>
                <!-- Begin MailChimp Signup Form -->
                <div id="mc_embed_signup">
                    <form action="" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                        <div id="mc_embed_signup_scroll">
                            <label for="mce-EMAIL" class="screen-reader-text">Email Address</label>
                            <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
                            <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>


                        </div>
                    </form>
                </div>
                <!--End mc_embed_signup-->
            </aside><!-- .widget -->
            <aside class="widget widget-text">
                <h2 class="widget-title">Contact</h2>
                <p>Hello, Here some Text Already, you can modify this sidebar in the organisers.yml file!</p>
                <ul class="contacts">
                    <li><span class="icon icon-envelope" aria-hidden="true"></span> your@mail.com</li>
                    <li><span class="icon icon-map-marker" aria-hidden="true"></span> Switzerland</li>
                </ul>
            </aside><!-- .widget -->
        </div><!-- .widget-area -->
        <a class="sidebar-toggle"><span class="screen-reader-text">Close Sidebar</span><span class="icon" aria-hidden="true"></span></a>
    </div><!-- .sidebar-scrollable -->
</div><!-- .sidebar -->



    <div class="page-content">
      <div class="wrapper">
        


<!--
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header"> 
    <h2 class="post-date"><time datetime="2016-01-26T00:00:00+01:00" itemprop="datePublished">January 26, 2016</time></h2>
    <h3 class="post-time">From 10:00 to </h3>
  </header>
</article> --> 
        


        <article class="post tag-space space-science" itemscope itemtype="http://schema.org/BlogPosting">            
            <header class="cover post-header">
                <div class="post-bg" style="background-image:url(/img/779699537035500360-1.jpg);"></div>
                <div class="cover-content">
                    <div class="inner">
                        <h1 class="post-title">Implement Passportjs authentication with Sailsjs</h1>
                        <div class="post-meta">
                            by <span class="post-author"><a href="/about" itemscope itemtype="http://schema.org/Person">  Glas</a></span> on <time class="published" datetime="2015-10-05" datetime="2016-01-26T00:00:00+01:00" itemprop="datePublished" >Jan 26, 2016</time> <span class="reading-time"> <span class="eta"></span></span>
                        </div><!-- .post-meta -->
                        <a href="#" class="scroll-down square light icon-chevron-down"><span class="screen-reader-text">Scroll Down</span></a>
                    </div><!-- .inner -->
                </div><!-- .cover-content -->
            </header><!-- .cover -->
            <div class="post-content inner">
                <p></p>
                <p><h2 class="section-heading">sailsjs, passportjs, nodejss</h2>

<p>Step 1: dependencies
Add these dependencies to the yourproject/package.json file:</p>

<pre class=" language-javascript"><code class=" language-javascript"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">"bcrypt"</span><span class="token punctuation">:</span> <span class="token string">"~0.8.0"</span><span class="token punctuation">,</span>
    <span class="token string">"passport"</span><span class="token punctuation">:</span> <span class="token string">"~0.2.1"</span><span class="token punctuation">,</span>
    <span class="token string">"passport-local"</span><span class="token punctuation">:</span> <span class="token string">"~1.0.0"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
</code>
</pre>
<p>Open the terminal, go to your project folder and run:</p>

<p>[sudo] npm install</p>

<p>Step 2: create user model
To create a user model run the following command:</p>

<p>sails generate api user</p>

<p>This will automatically create a model and a controller. You can find the model at yourproject/api/models/User.js. Let’s make that file look like this:</p>

<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
            required<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
            unique<span class="token punctuation">:</span> <span class="token keyword">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
            minLength<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            required<span class="token punctuation">:</span> <span class="token keyword">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        toJSON<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    beforeCreate<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bcrypt<span class="token punctuation">.</span><span class="token function">genSalt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> salt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    user<span class="token punctuation">.</span>password <span class="token operator">=</span> hash<span class="token punctuation">;</span>
                    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Step 3: create AuthController
Run this command from your terminal: 
sails generate controller auth</p>

<p>Then go to yourproject/api/controllers/AuthController.js and alter it in this way:</p>

<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>

    _config<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        actions<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
        shortcuts<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
        rest<span class="token punctuation">:</span> <span class="token keyword">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    login<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    message<span class="token punctuation">:</span> info<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    user<span class="token punctuation">:</span> user
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            req<span class="token punctuation">.</span><span class="token function">logIn</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    message<span class="token punctuation">:</span> info<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    user<span class="token punctuation">:</span> user
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    logout<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Step 4: create login and signup views
Create this file yourproject/views/signup.ejs:</p>

<pre class=" language-markup"><code class=" language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Signup<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/user<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code>
</pre>

<p>And then this yourproject/views/login.ejs:</p>

<pre class=" language-markup"><code class=" language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code>
</pre>

<p>These forms look the same, besides the action.</p>

<p>Step 5: configuring the routes
Let’s set up our routes in yourproject/config/routes.js like this:</p>

<pre class=" language-javascript"><code class=" language-javascript">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'/'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">:</span> <span class="token string">'homepage'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token string">'get /login'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
       view<span class="token punctuation">:</span> <span class="token string">'login'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token string">'post /login'</span><span class="token punctuation">:</span> <span class="token string">'AuthController.login'</span><span class="token punctuation">,</span>

  <span class="token string">'/logout'</span><span class="token punctuation">:</span> <span class="token string">'AuthController.logout'</span><span class="token punctuation">,</span>

  <span class="token string">'get /signup'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">:</span> <span class="token string">'signup'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>If you notice we are leveraging HTTP verbs, we have two login actions but different routes.</p>

<p>Step 6: configuring Express Middleware
Since we are using Passport we have to customize our middleware in yourproject/config/http.js:</p>

<pre class=" language-javascript"><code class=" language-javascript">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token punctuation">{</span>
   middleware<span class="token punctuation">:</span> <span class="token punctuation">{</span>

    passportInit    <span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    passportSession <span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

     order<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'startRequestTimer'</span><span class="token punctuation">,</span>
            <span class="token string">'cookieParser'</span><span class="token punctuation">,</span>
            <span class="token string">'session'</span><span class="token punctuation">,</span>
            <span class="token string">'passportInit'</span><span class="token punctuation">,</span>     
            <span class="token string">'passportSession'</span><span class="token punctuation">,</span> 
            <span class="token string">'myRequestLogger'</span><span class="token punctuation">,</span>
            <span class="token string">'bodyParser'</span><span class="token punctuation">,</span>
            <span class="token string">'handleBodyParserError'</span><span class="token punctuation">,</span>
            <span class="token string">'compress'</span><span class="token punctuation">,</span>
            <span class="token string">'methodOverride'</span><span class="token punctuation">,</span>
            <span class="token string">'poweredBy'</span><span class="token punctuation">,</span>
            <span class="token string">'router'</span><span class="token punctuation">,</span>
            <span class="token string">'www'</span><span class="token punctuation">,</span>
            <span class="token string">'favicon'</span><span class="token punctuation">,</span>
            <span class="token string">'404'</span><span class="token punctuation">,</span>
            <span class="token string">'500'</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Into the order array we added passportInit and passportSession after the session element. The name of this array is quite self-explanatory, the elements must be ordered this way.</p>

<p>Step 7: define Passport local strategy for authentication
Into yourproject/config/ folder let’s create a new file called passport.js:</p>

<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
LocalStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport-local'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Strategy<span class="token punctuation">,</span>
bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> id <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LocalStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    usernameField<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
    passwordField<span class="token punctuation">:</span> <span class="token string">'password'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> email <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'Incorrect email.'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              message<span class="token punctuation">:</span> <span class="token string">'Invalid Password'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> returnUser <span class="token operator">=</span> <span class="token punctuation">{</span>
            email<span class="token punctuation">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
            createdAt<span class="token punctuation">:</span> user<span class="token punctuation">.</span>createdAt<span class="token punctuation">,</span>
            id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> returnUser<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token string">'Logged In Successfully'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Step 8: add a new policy
Let’s create a new policy isAuthenticated.js into the yourproject/api/policies/ folder:</p>

<pre class=" language-javascript"><code class=" language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Briefly, we are telling Sails what to do if a user is not authenticated, then we can bind this policy to any of the controllers in the app.</p>

<p>Step 9: bind the policy to a controller
Let’s create a controller and a model just for testing what we have done. I am going to call this api post.</p>

<p>sails generate api post</p>

<p>Then let’s bind the policy to the PostController by updating yourproject/config/policies.js:</p>

<pre class=" language-javascript"><code class=" language-javascript">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>policies <span class="token operator">=</span> <span class="token punctuation">{</span>

   <span class="token string">'*'</span><span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>

  <span class="token string">'PostController'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'*'</span><span class="token punctuation">:</span> <span class="token string">'isAuthenticated'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code>
</pre>

<p>Now the ‘GET /post’ route (and all the other routes automatically generated for this controller ) is available only to authenticated users.</p>

<p>Step 10: run a test
Lift your application 
sails lift 
And then go and play with these routes:</p>

<p>http://localhost:1337/post - the very first time it should redirect you to the login page</p>

<p>go to http://localhost:1337/signup for signing up</p>

<p>go to http://localhost:1337/login for logging in</p>

<p>now you should be able to access this page http://localhost:1337/post, even though it’s going to show you just an empty array (there aren’t any posts yet)</p>

<p>go to http://localhost:1337/logout for logging out</p>

<p><a href="https://github.com/iliketomatoes/passport_with_sails">→ Get the repository on Github</a></p>

<p>I would very much appreciate your comments, especially if you find an error or you need a further explanation.
References:</p>

<p><a href="http://sailsjs.org/#/documentation/concepts">→ Sails.js</a> 
<a href="http://passportjs.org/">→ Passport.js</a> 
<a href="hhttps://github.com/balderdashy/waterline">→ Waterline</a></p>

<blockquote>When in doubt, use brute force.

        — Ken Thompson

</blockquote>

</p>
                <div id="disqus_thread"></div>
                <script>
                    /**
                     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                     */
                    /*
                    var disqus_config = function () {
                        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                    };
                    */
                    (function() {  // DON'T EDIT BELOW THIS LINE
                        var d = document, s = d.createElement('script');
                        
                        s.src = '//lucasgatsas.disqus.com/embed.js';
                        
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
                </noscript>



        <div>
            <a href='mailto:your@mail.com?subject=Register interest for Implement Passportjs authentication with Sailsjs on January 26, 2016&body=Hi! Im interested in your Work. Can we Meet?' class="button button-primary">Contact</a>
        </div>

            </div><!-- .post-content -->
            <footer class="post-footer inner">
                <div class="share-post">
                    <span>Share</span>
                    <a class="icon-twitter square" target="_blank" href="http://twitter.com/share?text=&url="><span class="screen-reader-text">Twitter</span></a>
                    <a class="icon-facebook square" target="_blank" href="http://wwww.facebook.com/sharer.php?"><span class="screen-reader-text">Facebook</span></a>
                    <a class="icon-google square" target="_blank" href="http://plus.google.com/share?url=/"><span class="screen-reader-text">Google+</span></a>
                </div>
                <div class="author-box">
                        
                            <img src="http://127.0.0.1:8000/assets/img/avatar@2x.png" alt="Jane Doe" class="author-avatar" />
                        
                            
                    <h4 class="author-title">About 
                        <a href=""> Glas</a>
                    </h4>
                     
                    <p class="author-description">Lucas Gatsas, is a Web -Developer, Front -End Engineer & UI/UX Designer based in  St. Gallen, Switerland.
</p>
                    <p class="author-links">
                        <span class="author-location">
                        <i class="icon-map-marker" aria-hidden="true"></i> 
                        Switzerland
                        </span>
                            <span class="author-website">
                            <i class="icon-chain" aria-hidden="true"></i> 
                            <a href="spaceg.github.io" target="_blank">spaceg.github.io</a>
                        </span> 
                              <span class="author-website">
                              <i class="icon-chain" aria-hidden="true"></i> 
                              <a href="mailto:your@mail.com" target="_blank">your@mail.com</a>
                        </span> 
                        
                    </p>
                </div>   
                   <ul class="pager">
                    
                    <li class="previous">
                        <a href="/event/nmap-mac-osx.html" data-toggle="tooltip" data-placement="top" title="NMAP MAC OSX" id="pagehove">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/event/npm-bcrypt.html" data-toggle="tooltip" data-placement="top" title="bycrypt" id="pagehove">Next Post &rarr;</a>
                    </li>
                    
                </ul>
               
            </footer><!-- .post-footer -->

        </article><!-- .post -->


             

      </div>
    </div>

    

<footer class="site-footer">
  <div class="footer-top">
    <div class="inner-wide">
      <div class="offsite-links">
        <a href="http://www.twitter.com/" class="icon-twitter"><span class="screen-reader-text">Twitter</span></a>
        <a href="https://www.facebook.com/" class="icon-facebook"><span class="screen-reader-text">Facebook</span></a> 
        <a href="https://plus.google.com/" class="icon-google"><span class="screen-reader-text">Google+</span></a>
        <a href="https://github.com/" class="icon-github"><span class="screen-reader-text">GitHub</span></a>
        <a href="https://medium.com/" class="icon-medium"><span class="screen-reader-text">Medium</span></a>
        <a href="http://instagram.com/" class="icon-instagram"><span class="screen-reader-text">Instagram</span></a>
        <a href="https://www.youtube.com/" class="icon-youtube"><span class="screen-reader-text">YouTube</span></a>
        <a href="http://blog.lucasgatsas.ch/feed.xml" class="icon-feed"><span class="screen-reader-text">RSS</span></a>
      </div>
      <a href="#" class="top-link square icon-chevron-up" title="Back to Top"><span class="screen-reader-text">Back to the top</span></a>
    </div>
  </div>
  <div class="site-info inner-wide">



  <div class="read-more">
     <a href='mailto:your@mail.com?subject=Register interest for Implement Passportjs authentication with Sailsjs on January 26, 2016&body=Hi! Im interested in your Work. Can we Meet?' class="button light1">Contact Me</a>

            </div><br><br>
    <p>&copy;. 2017 by <a href="Lucas Gatsas">   Lucas Gatsas <!-- Lucas Gatsas, is a Web -Developer, Front -End Engineer & UI/UX Designer based in  St. Gallen, Switerland.
 --> </a> <br>all rights reserved. <br /> This site is built with <a href="http://rubyonrails.org/" target="_blank"> Ruby on Rails </a>
 </p>   
  </div>
</footer>

  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>


<script src="/assets/js/plugins-v=cba79c2df0.js"></script>
<script src="/assets/js/html5-v=cba79c2df0.js"></script>
<script src="/assets/js/custom-v=cba79c2df0.js"></script>





            <div class="overlay"></div>
  </div><!-- #page -->  


    <script id="dsq-count-scr" src="//lucasgatsas.disqus.com/count.js" async></script>

  </body>

</html>
